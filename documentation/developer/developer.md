# Developer documentation

## About the fonts

SIL currently has six Arabic script fonts. These can be divided into three groups.

### Nastaliq. Graphite only

Covers only those characters that are used by languages using the Nastaliq script.

- Awami Nastaliq

### Naskh — Kano style. OpenType only

These fonts are in the Kano style of writing and cover only characters that are used by a subset of West African languages.
 
- Alkalami
- Ruwudu

### Naskh — traditional style. OpenType only

These traditional style fonts attempt to cover all the characters in the Arabic BMP blocks, excluding Presentations Forms.

- Scheherazade New - a widely used Naskh font.
- Lateef - developed for the Sindhi language and nearby languages. However, it is more widely used because it gives nice contrast for section headings and titles.
- Harmattan - for use in West Africa, although we have discovered it is more widely used because it is quite readable on mobile devices.

Note, however, that reh and waw kerning rules implemented in Harmattan are autogenerated by rendering text via Graphite rules that implement collision-avoidance-based kerning. Harmattan developers must, therefore, maintain both Graphite and OpenType font logic even though the released font contains only OpenType logic. For more information see Harmattan developer information.

## About OpenType FEA and FEAX source code

The OpenType "smarts" in most SIL fonts is authored in an extended version of [Adobe Feature File (FEA)](https://github.com/adobe-type-tools/afdko/blob/develop/docs/OpenTypeFeatureFileSpecification.md) syntax. To denote the use of these extensions, the filename suffix `.feax` is used. Note that the extensions are merely syntactic sugar in that they cannot do anything more than Adobe FEA files can do, but some complex and tedious code can be expressed more simply in FEAX than in FEA. For more information about FEAX, see [FEA Extensions](https://github.com/silnrsi/feax/blob/main/docs/feaextensions.md).

## font-arab-tools

### absGlyphList/

This spreadsheet, maintained using Microsoft Excel and saved in both `.xslx` binary and `.csv` text formats, is used to manage the glyphs for all Naskh fonts. 
Changes are made first to the `.xlsx` file, from which the `.csv` file is generated. 
See specific instructions in the text box at the top of `absGlyphList.xlsx`.
Always commit matching `.xlsx` and `.csv` files, using the git diff of the `csv` files to check that all modifications are as intended.

Project-specific `glyph_data.csv` files can be extracted from `absGlyphList.csv` using `tools/make_glyphdata.py`.

For more information, see [absGlyphList/README.md](../../absGlyphList/README.md).

_TODO: Adjust the above link when this file moves_

_TODO: Do we need to move the ABS features Google spreadsheet to an .xls or .csv in this repo?_

### tools/

Executable tools in the `/tools` folder include:
- `make_glyphdata.py` - Extract project-specific `glyph_data.csv` from the `absGlyphList.csv`. For more information see `absGlyphList/README.md`
- `makeLamAlefLigs.py` - In a UFO, construct lam-alef ligature glyphs from the component `*.preAlef*` and `*.postLam*` glyphs.
- `absgenclasses.py` - Update some of the glyph classes (defined in the project's `source/classes.xml` file). 
- `absgenftml.py`- Generate ftml tests.
- `copycommon-*` - updates files shared among Scheherazade, Harmattan and Lateef. See below.

## Sharing source files and data among the Arabic font projects

Because of the common histories of some of our Arabic font projects, there is an opportunity to lower cost of development and maintenance by sharing source files that are identical. Examples:

- As described more fully below, the main OpenType logic for Scheherazade, Harmattan, and Lafeef is implemented in files that are identical in all three projects, utilizing FEAX conditionals for minor differences in behavior between the fonts. 
- Certain tools, such as those for auto-generating FTML test files or XML classes files, are identical for all projects.

Unlike some software development projects where an entire repo might be re-used by multiple projects, we have only a handful of files that benefit from being maintained in common. Therefore the git submodule concept use by many software projects is overkill.

Instead, we use a simple shell script that copies the shared files to all relevant repos. At present, for this to work, the repos in question must all be peers in your local storage. For the Arabic font families, this means having a local storage structure as follows:

```
    ..../fonts/
          +--- font-arab-tools/
          +--- font-lateef/
          +--- font-harmattan/
          +--- font-scheherazade/
          +--- font-alkalami/      
          +--- font-ruwudu/
```

Any files that are shared within these font projects must, within all repos, be in the same location. For example: Scheherazade, Harmattan, Lateef and font-arab-tools repos contain the following shared files
```
                .../source/opentype/gsub.feax
                .../source/opentype/gpos.feax
                .../source/additional_ucd.xml
                .../tools/absgenftml.py
                .../tools/absgenclasses.py
                .../tools/copycommon-shl
```

(NB: There are actually more files shared than these; for the complete list see the `files` variable in the relevant `copycommmon` script)

At present there are two groups of projects that share files:
- Scheherazade, Harmattan, Lateef (and font-arab-tools) share the most files, and the shell script for these projects is `tools/copycommon-shl`
- Alkalami, Ruwudu (and, again, font-arab-tools) share a few files, and the shell script for these projects is `tools/copycommon-ra`

Development of shared files can happen in any of the repos and then that repo's `copycommon` can be used to propagate changes from the project you are working on to the related repos. A `-q` option exists for those who prefer less verbose progress messaging, and `-d` will cause the script to "dry run", i.e., report what it would do without actually copying any files (see example below).

### Recommended Shared-file Workflow

It is helpful to focus on one repo at a time during development, e.g., do all initial development and testing within `font-scheherazade`. 

Once the code is working in one repo, you'll need to copy it to the related projects and confirm it works there. However, before doing this it is helpful to make sure those project repos are up-to-date (i.e. pulled) with no uncommitted and unrelated changes of their own. 

As for actually copying, this can be done manually or use the relevant `copycommon` script. The former is useful during development, for example, to test one related project with the new code. The latter can always be used, and is especially useful when the code changes are nearing completion. 

For example, suppose you've been enhancing code in Scheherazade. Then from the `font-scheherade` folder you can dry-run the copy, which might work as follows:

```
/smith/font-scheherazade❯ tools/copycommon-shl -h
Usage: copycommon-shl [-q] [-d]
      -q  suppress most output
      -d  dry-run (don't actually copy)

/smith/font-scheherazade❯ tools/copycommon-shl -q -d
Sending files from font-scheherazade to ../font-harmattan
  Would copy source/opentype/gpos.feax
Sending files from font-scheherazade to ../font-lateef
  Would copy source/opentype/gpos.feax
Sending files from font-scheherazade to ../font-arab-tools
  Would copy source/opentype/gpos.feax

 /smith/font-scheherazade❯ 
```

When you're ready to actually copy the shared files, just remove the `-d` option (or remove both options for more verbose output).

Finally, review and commit changes in all the relevant repos, being sure to examine diffs carefully to make sure there are no unexpected changes.

## Project-specific developer information
### Awami Nastaliq

Awami Nastaliq has extensive developer documentation [in the repo](https://github.com/silnrsi/font-awami/tree/master/documentation/developer).

### Naskh, Kano-style

These two fonts could potentially use the same codebase as each other in the future. However, Alkalami has many swash tailed glyphs that Ruwudu did not need. At this point the two fonts have the same character set, and `copycommon-ra` is used only to manage utility files in the repos.

- `master.feax` - Master source file for OpenType logic. Many/most of the classes have been hand-generated and might benefit from moving to autogenerated classes.

The Alkalami font has a lot of contextual substitutions for all the deep swashes. Ruwudu does not require those.

### Naskh, traditional style

Starting with v4.000, Scheherazade New, Lateef, and Harmattan are being developed and released in parallel. The `gsub.feax` and `gpos.feax` files are identical for all three, and we hope to do additional source code unification in future releases.

_TODO: Create documentation based on Qs that the developer has asked._

- `main.feax` - Master source file for OpenType logic (project specific)
  - `gsub.feax` - Substitution lookups (shared)
  - `gpos.feax` - Positioning Lookups (shared)
    - `customKerning.feax` - project-specific kerning lookups (e.g. for collision avoidance). GPOS lookups in this file will execute first, before any lookups coded in gpos.feax itself. 
    - `customShifting.feax` - project-specific mark adjustments (e.g. for collision avoidance). GPOS lookups in this file will execute last; importantly this is after built-in mark-to-base and mark-to-mark rules.


